# Bitcask IoT 开发日志

## 2026-02-06

### 🔍 目前的代码状态

* **垂直路径已打通**：写入数据点 -> 存入内存 -> 满足条件 -> 打包刷入磁盘 -> 返回索引项。
* **并发安全**：在所有关键路径（Index 查找、Buffer 追加、文件写入、文件并发读）都使用了 `sync.RWMutex` 或双重检查锁。
* **存储能力**：实现了基于 `gob` 的 Block 序列化与 `Segment` 文件的 `ReadAt` 并发读取。

### 💡 数据结构重构重点 (Bitcask -> IoT)

*   **聚合：从“点”到“块”**：
    放弃单点存储，改为 **Block (块)** 存储。内存索引不再记录每个数据点，而是记录块的时间范围和物理位置。内存消耗降低 99%，支持快速范围查询。 
*   **压缩：String -> uint32 ID**：
    引入 ID 映射机制。磁盘不再存储冗长的传感器名称，统一使用 4 字节 ID。在万级传感器场景下，大幅减少存储冗余。
*   **进化：Hash -> 稀疏索引**：
    将 Bitcask 原始的哈希索引改为 **时间线稀疏索引 (BlockMeta)**。利用二分查找快速定位磁盘块，解决 KV 引擎无法处理时间范围检索的问题。

### 🚧 接下来的重点（待完成）

1. **Segment 轮转管理**：实现 `Manager` 结构，当文件写满（如 512MB）时自动切换新文件。
2. **引擎协调器 (`internal/engine`)**：初始化各组件，配置路径，管理全局生命周期。
3. **崩溃恢复 (Recovery)**：实现 WAL 或通过扫描 Segment 重建内存索引。
4. **查询能力 (`internal/query`)**：实现按时间范围检索并解压数据。


---

