## Storage


```
+-----------------------------------------------------------------------+
|                       File: segment-001.vlog                          |
+=======================================================================+
|                            (Append Only)                              |
|                                                                       |
|  +---------------------------+       +---------------------------+    |
|  |      Block #1 (Data)      |       |      Block #2 (Data)      |    |
|  +---------------------------+       +---------------------------+    |
|  | [Gob Encoded Bytes]       |       | [Gob Encoded Bytes]       |    |
|  |                           |       |                           |    |
|  | Struct Block {            |       | Struct Block {            |    |
|  |   SensorID: 1024          |       |   SensorID: 2048          |    |
|  |   Points: [               |       |   Points: [               |    |
|  |     {T:100, V:25.5},      |       |     {T:100, V:80.1},      |    |
|  |     {T:101, V:25.6},      |       |     {T:101, V:80.2},      |    |
|  |     ...                   |       |     ...                   |    |
|  |   ]                       |       |   ]                       |    |
|  | }                         |       | }                         |    |
|  +---------------------------+       +---------------------------+    |
|  ^                                   ^                                |
|  | Offset: 0                         | Offset: 512 (假设)              |
+--|-----------------------------------|--------------------------------+
```

---

## Memory Index

```
   +----------------------+
   |  Index (Global Map)  |
   |  map[string]*Series  |
   +----------+-----------+
              |
      Key: "sensor_temp"
              |
              v
+-------------+-------------------------------------------------------+
|  Series (Struct)                                                    |
+=====================================================================+
|  ID: 1024                                                           |
|                                                                     |
|  [1] ActiveBuffer (Slice) --> 热数据 (Hot)                          |
|  +---------------------------------------------------------------+  |
|  | Point{T:105, V:25.8} | Point{T:106, V:25.9} | ... (Waiting)   |  |
|  +---------------------------------------------------------------+  |
|                                                                     |
|  [2] Blocks (Slice) --> 冷数据索引 (Cold Index)                      |
|  +---------------------------------+-----------------------------+  |
|  | Meta [0]                        | Meta [1]                    |  |
|  +---------------------------------+-----------------------------+  |
|  | MinTime: 100                    | MinTime: 200                |  |
|  | MaxTime: 104                    | MaxTime: 250                |  |
|  | Offset : 0    ------------------|--------+                    |  |
|  | Size   : 512                    |        |                    |  |
|  +---------------------------------+        |                    |  |
+---------------------------------------------|-----------------------+
                                              |
                                              | (指向磁盘位置)
                                              v
                                   File: segment-001.vlog
```

## Data Flow 

```
Step 1: Write (写入)
   User Put()
       |
       v
 +------------------+
 | ActiveBuffer     |  <-- 内存攒数据
 | [P1, P2... P99]  |
 +------------------+

Step 2: Flush (刷盘)
   (Buffer 满了)
       |
       v
 +------------------+      gob.Encode()       +-------------------+
 | Block (Struct)   | ----------------------> | Bytes ([]byte)    |
 | {ID, Points...}  |                         | 0x1F 0x8B ...     |
 +------------------+                         +---------+---------+
                                                        |
                                                        | Append Write
                                                        v
                                              +-------------------+
                                              | Disk File (.vlog) |
                                              +-------------------+

Step 3: Index Update (更新索引)
   (File Return)
       | Offset: 1024, Size: 500
       v
 +------------------+
 | Append to Series |
 | Blocks []Meta    |
 +------------------+
 ```