# Bitcask IoT é¡¹ç›®æŒ‡å—

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**Bitcask IoT Storage Engine** æ˜¯ä¸€ä¸ªåŸºäº TSM (Time-Structured Merge Tree) å˜ä½“çš„åµŒå…¥å¼æ—¶åºå­˜å‚¨å¼•æ“ï¼Œä¸“ä¸º IoT åœºæ™¯çš„é«˜é¢‘å†™å…¥å’ŒèŒƒå›´æŸ¥è¯¢ä¼˜åŒ–ã€‚é¡¹ç›®é‡‡ç”¨å†…å­˜ç¼“å†²ï¼ˆWrite Bufferï¼‰+ æ•°æ®åˆ†å—ï¼ˆChunkingï¼‰+ ç¨€ç–ç´¢å¼•ï¼ˆSparse Indexï¼‰çš„æ¶æ„è®¾è®¡ã€‚

### æ ¸å¿ƒç‰¹æ€§
- ğŸš€ é«˜ååå†™å…¥ï¼šé€šè¿‡ WAL + MemBuffer å®ç°
- ğŸ’¾ é«˜æ•ˆå‹ç¼©ï¼šDelta-of-Delta å’Œ XOR ç¼–ç 
- ğŸ” å¿«é€ŸæŸ¥è¯¢ï¼šç¨€ç–ç´¢å¼• + Block çº§åˆ«æ£€ç´¢
- ğŸ”„ å´©æºƒæ¢å¤ï¼šWAL é‡æ”¾æœºåˆ¶
- ğŸ“Š æ—¶åºä¼˜åŒ–ï¼šä¸“ä¸º IoT æ•°æ®è®¾è®¡

### æŠ€æœ¯æ¶æ„
```
æ•°æ®æº â†’ é‡‡é›†å±‚ â†’ å¼•æ“åè°ƒ â†’ å†…å­˜ç¼“å†² â†’ å‹ç¼©åˆ†å— â†’ ç£ç›˜å­˜å‚¨
                 â†‘                    â†‘
              å…ƒæ•°æ®ç®¡ç†           é¢„å†™æ—¥å¿— (WAL)
```

---

## ğŸ›  æŠ€æœ¯æ ˆ

### æ ¸å¿ƒç¯å¢ƒ
- **è¯­è¨€**: Go 1.23.0+ (toolchain go1.24.12)
- **æ¨¡å—å**: github.com/bitcask-iot/engine

### ä¸»è¦ä¾èµ–åº“

#### å‹ç¼©ä¸ç¼–ç 
- `github.com/golang/snappy` - Data Block å‹ç¼©

#### å·¥ä¸šåè®®
- `github.com/gopcua/opcua` - OPC UA å®¢æˆ·ç«¯

#### å‘½ä»¤è¡Œä¸é…ç½®
- `github.com/spf13/cobra` - CLI æ¡†æ¶
- `github.com/spf13/viper` - é…ç½®ç®¡ç†

#### Web æœåŠ¡
- `github.com/gin-gonic/gin` - HTTP API æœåŠ¡

#### æ—¥å¿—
- `github.com/uber-go/zap` - é«˜æ€§èƒ½æ—¥å¿—

### æ ‡å‡†åº“æ·±åº¦ä½¿ç”¨
- `encoding/binary` - Block Header BigEndian ç¼–ç 
- `os` & `io` - æ–‡ä»¶ Seek, ReadAt, Append æ“ä½œ
- `sync/atomic` - æ— é”æŒ‡æ ‡ç»Ÿè®¡
- `sort` - ç´¢å¼•äºŒåˆ†æŸ¥æ‰¾

---

## ğŸ“ é¡¹ç›®ç»“æ„

```
bitcask-iot/
â”œâ”€â”€ cmd/                          # [å…¥å£å±‚] åº”ç”¨ç¨‹åºå…¥å£
â”‚   â”œâ”€â”€ server/
â”‚   â”‚   â””â”€â”€ main.go               # æœåŠ¡ç«¯å…¥å£ï¼Œå¯åŠ¨ DB å¹¶ç›‘å¬ TCP ç«¯å£
â”‚   â””â”€â”€ cli/
â”‚       â””â”€â”€ main.go               # å®¢æˆ·ç«¯å…¥å£ï¼Œå¯åŠ¨äº¤äº’å¼ Shell
â”‚
â”œâ”€â”€ configs/                      # [é…ç½®]
â”‚   â””â”€â”€ config.yaml               # é…ç½®æ–‡ä»¶ (æ–°å¢åœ°å€ç«¯å£é…ç½®)
â”‚
â”œâ”€â”€ core/                      # ğŸŒŸ [å­˜å‚¨æ ¸å¿ƒ] (åŸ engine + core åˆå¹¶)
â”‚   â”œâ”€â”€ db.go                     # æ•°æ®åº“å¯¹å¤–é—¨é¢ï¼Œåè°ƒ IO ä¸ç´¢å¼•
â”‚   â”œâ”€â”€ options.go                # é…ç½®é€‰é¡¹æ¨¡å¼å®ç°
â”‚   â”œâ”€â”€ block.go                  # æ•°æ®åˆ†å—å®šä¹‰ä¸äºŒè¿›åˆ¶ç¼–è§£ç 
â”‚   â”œâ”€â”€ segment.go                # åº•å±‚ç‰©ç†æ–‡ä»¶ IO æ“ä½œ (Append-Only)
â”‚   â”œâ”€â”€ index.go                  # å†…å­˜ç´¢å¼•ç®¡ç† (Key æ˜ å°„ç‰©ç†ä½ç½®)
â”‚   â”œâ”€â”€ manager.go                # æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç† (è½®è½¬ã€å½’æ¡£)
â”‚   â””â”€â”€ series.go                 # IOT æ—¶é—´çº¿æ•°æ®ç¼“å†²ä¸ç®¡ç†
â”‚
â”œâ”€â”€ protocol/                     # ğŸŸ£ [åè®®å±‚] (æ–°å¢)
â”‚   â””â”€â”€ codec.go                  # é€šä¿¡åè®®å®šä¹‰ä¸ç²˜åŒ…å¤„ç† (LTV æ ¼å¼)
â”‚
â”œâ”€â”€ tcp/                          # ğŸ”µ [ç½‘ç»œå±‚] (æ–°å¢)
â”‚   â”œâ”€â”€ server.go                 # TCP æœåŠ¡ç«¯ç›‘å¬ä¸è¿æ¥ç®¡ç†
â”‚   â””â”€â”€ handler.go                # ä¸šåŠ¡é€»è¾‘èƒ¶æ°´ï¼Œæ¡¥æ¥ Protocol ä¸ DB
â”‚
â”œâ”€â”€ client/                       # ğŸŸ  [SDK å±‚] (æ–°å¢)
â”‚   â””â”€â”€ client.go                 # å®¢æˆ·ç«¯ SDKï¼Œå°è£…ç½‘ç»œè¯·æ±‚ç»†èŠ‚
â”‚
â”œâ”€â”€ pkg/                          # [å…¬å…±åº“] (ä¿æŒä¸å˜)
â”‚   â”œâ”€â”€ config/                   # Viper é…ç½®åŠ è½½ä¸çƒ­é‡è½½
â”‚   â”œâ”€â”€ logger/                   # Zap æ—¥å¿—ç»Ÿä¸€å°è£…
â”‚   â””â”€â”€ utils/                    # é€šç”¨å·¥å…·å‡½æ•° (ID, Time)
â”‚
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â””â”€â”€ README.md
```

### æ¨¡å—èŒè´£

#### cmd/
- **server**: æœåŠ¡å…¥å£ï¼Œåˆå§‹åŒ–æ‰€æœ‰ç»„ä»¶
- **cli**: è°ƒè¯•å·¥å…·ï¼Œæ”¯æŒæŸ¥è¯¢ã€ç»Ÿè®¡ç­‰æ“ä½œ

#### engine/
- **engine**: æ•°æ®åº“å¯¹å¤–é—¨é¢ (Facade)ï¼Œåè°ƒ Indexã€Series å’Œ Storage

#### core/
- **block**: æ•°æ®åˆ†å—å®šä¹‰ä¸ç¼–è§£ç  (åŸºç¡€äºŒè¿›åˆ¶åºåˆ—åŒ–)
- **index**: å†…å­˜ç´¢å¼•ç®¡ç† (Series Map)
- **manager**: Segment æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç† (è½®è½¬ã€åˆ·ç›˜)
- **segment**: åº•å±‚æ–‡ä»¶ IO æ“ä½œ (Append-Only)
- **series**: å•ä¸ªæ—¶é—´çº¿çš„å†…å­˜ç¼“å†²ä¸ Block ç´¢å¼•ç®¡ç†

#### pkg/
- **config**: é…ç½®æ–‡ä»¶åŠ è½½å’ŒéªŒè¯
- **logger**: ç»Ÿä¸€æ—¥å¿—æ¥å£
- **utils**: æ—¶é—´å¯¹é½ã€ID ç”Ÿæˆç­‰å·¥å…·å‡½æ•°

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. ID æ˜ å°„æœºåˆ¶
- **å†™å…¥**: `GetOrRegister(name string) -> uint32`
- **è¯»å–**: `GetID(name string) -> uint32`
- **ä¼˜åŠ¿**: ç£ç›˜åªå­˜å‚¨ uint32ï¼ŒèŠ‚çœç©ºé—´

### 2. å†™å…¥è·¯å¾„
```
æ•°æ®ç‚¹ â†’ WAL (Crash Safe) â†’ MemBuffer â†’ Flush â†’ å‹ç¼© â†’ Block â†’ Segment
```
- WAL ä¿è¯æ•°æ®å®‰å…¨
- Buffer ç§¯æ”’æ•°æ®ï¼ˆ>1KB æˆ– >60sï¼‰
- Delta-of-Delta å‹ç¼©æ—¶é—´æˆ³
- XOR å‹ç¼©æ•°å€¼

### 3. ç‰©ç†å­˜å‚¨æ ¼å¼
```
Segment æ–‡ä»¶:
[Header: MagicNumber]
[Block 1: ID, Time, Size, Data]
[Block 2: ID, Time, Size, Data]
...
[Footer: Index Offset]
```
- æŒ‰ 2 å°æ—¶æˆ– 512MB è½®è½¬æ–‡ä»¶
- è¿‡æœŸåˆ é™¤æ—§æ–‡ä»¶ï¼ˆæ— éœ€ Compactionï¼‰

### 4. æŸ¥è¯¢æœºåˆ¶
```
Query(sensorID, start, end, maxPoints)
  â†’ ç´¢å¼•äºŒåˆ†æŸ¥æ‰¾
  â†’ åŠ è½½ç›¸å…³ Blocks
  â†’ è§£å‹è§£ç 
  â†’ è¿‡æ»¤æ—¶é—´èŒƒå›´
  â†’ é™é‡‡æ ·ï¼ˆLTTBï¼‰
  â†’ è¿”å›ç»“æœ
```

### 5. å´©æºƒæ¢å¤
1. åŠ è½½å…ƒæ•°æ®ï¼ˆID æ˜ å°„ï¼‰
2. æ‰«æ Segment é‡å»º Block ç´¢å¼•
3. é‡æ”¾ WAL åˆ° MemBuffer

---

## ğŸ—º æ¶æ„å›¾

### Storage


```
+-----------------------------------------------------------------------+
|                       File: segment-001.vlog                          |
+=======================================================================+
|                            (Append Only)                              |
|                                                                       |
|  +---------------------------+       +---------------------------+    |
|  |      Block #1 (Data)      |       |      Block #2 (Data)      |    |
|  +---------------------------+       +---------------------------+    |
|  | [Gob Encoded Bytes]       |       | [Gob Encoded Bytes]       |    |
|  |                           |       |                           |    |
|  | Struct Block {            |       | Struct Block {            |    |
|  |   SensorID: 1024          |       |   SensorID: 2048          |    |
|  |   Points: [               |       |   Points: [               |    |
|  |     {T:100, V:25.5},      |       |     {T:100, V:80.1},      |    |
|  |     {T:101, V:25.6},      |       |     {T:101, V:80.2},      |    |
|  |     ...                   |       |     ...                   |    |
|  |   ]                       |       |   ]                       |    |
|  | }                         |       | }                         |    |
|  +---------------------------+       +---------------------------+    |
|  ^                                   ^                                |
|  | Offset: 0                         | Offset: 512 (å‡è®¾)              |
+--|-----------------------------------|--------------------------------+
```

---

### Memory Index

```
   +----------------------+
   |  Index (Global Map)  |
   |  map[string]*Series  |
   +----------+-----------+
              |
      Key: "sensor_temp"
              |
              v
+-------------+-------------------------------------------------------+
|  Series (Struct)                                                    |
+=====================================================================+
|  ID: 1024                                                           |
|                                                                     |
|  [1] ActiveBuffer (Slice) --> çƒ­æ•°æ® (Hot)                          |
|  +---------------------------------------------------------------+  |
|  | Point{T:105, V:25.8} | Point{T:106, V:25.9} | ... (Waiting)   |  |
|  +---------------------------------------------------------------+  |
|                                                                     |
|  [2] Blocks (Slice) --> å†·æ•°æ®ç´¢å¼• (Cold Index)                      |
|  +---------------------------------+-----------------------------+  |
|  | Meta [0]                        | Meta [1]                    |  |
|  +---------------------------------+-----------------------------+  |
|  | MinTime: 100                    | MinTime: 200                |  |
|  | MaxTime: 104                    | MaxTime: 250                |  |
|  | Offset : 0    ------------------|--------+                    |  |
|  | Size   : 512                    |        |                    |  |
|  +---------------------------------+        |                    |  |
+---------------------------------------------|-----------------------+
                                              |
                                              | (æŒ‡å‘ç£ç›˜ä½ç½®)
                                              v
                                   File: segment-001.vlog
```

### Data Flow 

```
Step 1: Write (å†™å…¥)
   User Put()
       |
       v
 +------------------+
 | ActiveBuffer     |  <-- å†…å­˜æ”’æ•°æ®
 | [P1, P2... P99]  |
 +------------------+

Step 2: Flush (åˆ·ç›˜)
   (Buffer æ»¡äº†)
       |
       v
 +------------------+      gob.Encode()       +-------------------+
 | Block (Struct)   | ----------------------> | Bytes ([]byte)    |
 | {ID, Points...}  |                         | 0x1F 0x8B ...     |
 +------------------+                         +---------+---------+
                                                        |
                                                        | Append Write
                                                        v
                                              +-------------------+
                                              | Disk File (.vlog) |
                                              +-------------------+

Step 3: Index Update (æ›´æ–°ç´¢å¼•)
   (File Return)
       | Offset: 1024, Size: 500
       v
 +------------------+
 | Append to Series |
 | Blocks []Meta    |
 +------------------+
 ```

---


## ğŸ”„ Hint File æ¶æ„è®¾è®¡æ€è·¯

  æ ¸å¿ƒæ€æƒ³

  æŠŠå¤æ‚çš„æ··åˆé—®é¢˜æ‹†æˆä¸¤ä¸ªç®€å•çš„çº¿æ€§é—®é¢˜ï¼š

   1. å†™æ•°æ®æ–‡ä»¶ï¼šçº¯è¿½åŠ å†™å…¥ï¼Œä¸è€ƒè™‘ä»»ä½•ç´¢å¼•é—®é¢˜
   2. é‡å»º Hint Fileï¼šçº¿æ€§æ‰«ææ•°æ®æ–‡ä»¶ï¼Œæå– Key-Value ä½ç½®ä¿¡æ¯

  ---

 ### ğŸ“ æ–‡ä»¶ç»“æ„

   ç›®å½•ç»“æ„ï¼š
   â”œâ”€â”€ segment-001.vlog     # æ•°æ®æ–‡ä»¶ï¼ˆçº¯è¿½åŠ ï¼Œåªå†™ï¼‰
   â”œâ”€â”€ segment-001.hint     # ç´¢å¼•æ–‡ä»¶ï¼ˆå¯åŠ¨æ—¶é‡å»ºï¼‰
   â”œâ”€â”€ segment-002.vlog
   â”œâ”€â”€ segment-002.hint
   â””â”€â”€ ...

  æ•°æ®æ–‡ä»¶æ ¼å¼ï¼ˆ.vlogï¼‰
   [Block 1 Length: 4B][Block 1 Data: N Bytes]
   [Block 2 Length: 4B][Block 2 Data: N Bytes]
   ...

  è¦ç‚¹ï¼š
   - çº¯è¿½åŠ å†™å…¥ï¼Œä¸éœ€è¦ç»´æŠ¤ä»»ä½•å†…éƒ¨ç´¢å¼•
   - ä¸éœ€è¦è½®è½¬æ—¶å†™å…¥ Footer æˆ– Index Block
   - å´©æºƒæ¢å¤æ—¶ï¼Œåªéœ€è¦æ‰«æåˆ°æœ€åä¸€ä¸ªå®Œæ•´çš„ Block

  Hint File æ ¼å¼ï¼ˆ.hintï¼‰
   KeyMap: SensorID -> [BlockMeta List]

  è¦ç‚¹ï¼š
   - å¯åŠ¨æ—¶çº¿æ€§æ‰«æ .vlog æ–‡ä»¶ç”Ÿæˆ
   - ä¹Ÿå¯ä»¥åœ¨å†™å…¥æ—¶åŒæ­¥è¿½åŠ ï¼ˆæƒè¡¡ï¼šå¯åŠ¨é€Ÿåº¦ vs å†™å…¥é€Ÿåº¦ï¼‰
   - å†…å­˜ä¸­åªéœ€è¦ç»´æŠ¤å½“å‰ Active Segment çš„ Hint

  ---

 ### ğŸ”„ å†™å…¥æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

   å†™å…¥è¯·æ±‚
     â”‚
     â”œâ”€ Series.Append(point)
     â”‚   â””â”€ ç‚¹åŠ å…¥ ActiveBuffer
     â”‚
     â”œâ”€ Series.ShouldFlush()
     â”‚   â””â”€ Buffer æ»¡äº†ï¼Ÿ
     â”‚
     â”œâ”€ Series.Flush()
     â”‚   â”œâ”€ 1. æ‰“åŒ… Block
     â”‚   â”œâ”€ 2. Manager.WriteBlock(block)
     â”‚   â”‚   â”œâ”€ æ£€æŸ¥ Active Segment æ˜¯å¦å†™æ»¡
     â”‚   â”‚   â”œâ”€ å†™æ»¡ â†’ ç®€å•å…³é—­æ—§æ–‡ä»¶ï¼Œåˆ›å»ºæ–°æ–‡ä»¶
     â”‚   â”‚   â””â”€ Segment.WriteBlock(block)
     â”‚   â”‚       â”œâ”€ Encode Block
     â”‚   â”‚       â”œâ”€ File.Write(data)  â† çº¯è¿½åŠ 
     â”‚   â”‚       â””â”€ è¿”å› Offset + Size
     â”‚   â”œâ”€ 3. æ›´æ–° Series.Blocks
     â”‚   â””â”€ 4. æ¸…ç©º ActiveBuffer
     â”‚
     â””â”€ è¿”å›æˆåŠŸ

  å…³é”®ç®€åŒ–ï¼š
   - âœ… Segment ä¸éœ€è¦ç»´æŠ¤å†…éƒ¨ç´¢å¼•
   - âœ… è½®è½¬æ—¶ä¸éœ€è¦å†™å…¥ Footer
   - âœ… ä¸éœ€è¦å¤„ç† Index Block çš„å¤æ‚ç¼–ç 

  ---

### ğŸ”„ å¯åŠ¨æ¢å¤æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

   å¯åŠ¨æµç¨‹
     â”‚
     â”œâ”€ æ‰«æç›®å½•ï¼Œæ‰¾åˆ°æ‰€æœ‰ .vlog æ–‡ä»¶
     â”‚
     â”œâ”€ å¯¹æ¯ä¸ª Segmentï¼š
     â”‚   â”œâ”€ æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯¹åº”çš„ .hint æ–‡ä»¶
     â”‚   â”‚
     â”‚   â”œâ”€ ã€è·¯å¾„1ã€‘æœ‰ Hint æ–‡ä»¶ä¸”æœ‰æ•ˆ
     â”‚   â”‚   â””â”€ ç›´æ¥åŠ è½½ Hint åˆ°å†…å­˜
     â”‚   â”‚
     â”‚   â””â”€ ã€è·¯å¾„2ã€‘æ—  Hint æˆ– Hint æ— æ•ˆ
     â”‚       â””â”€ çº¿æ€§æ‰«æ .vlog æ–‡ä»¶
     â”‚           â”œâ”€ è¯»å–æ¯ä¸ª Block
     â”‚           â”œâ”€ æå– SensorID + Offset + Size
     â”‚           â””â”€ é‡å»º Hint
     â”‚
     â””â”€ æ¢å¤å®Œæˆ

  å…³é”®ç®€åŒ–ï¼š
   - âœ… ä¸éœ€è¦å¤„ç† Footer çš„ Magic éªŒè¯
   - âœ… ä¸éœ€è¦å¤„ç† Index Block çš„è§£æ
   - âœ… å´©æºƒæ¢å¤é€»è¾‘ï¼šæ‰¾åˆ°æœ€åä¸€ä¸ªå®Œæ•´çš„ Block å³å¯

  ---

### ğŸ”„ è½®è½¬æµç¨‹ï¼ˆç®€åŒ–ç‰ˆï¼‰

   Segment è½®è½¬
     â”‚
     â”œâ”€ Active Segment å†™æ»¡
     â”‚
     â”œâ”€ å…³é—­å½“å‰ Active Segment
     â”‚   â”œâ”€ fsync ç¡®ä¿è½ç›˜
     â”‚   â””â”€ Close æ–‡ä»¶å¥æŸ„
     â”‚
     â”œâ”€ å°†å½“å‰ Segment ç§»å…¥ olderSegments
     â”‚
     â”œâ”€ åˆ›å»ºæ–°çš„ Active Segment (nextID)
     â”‚   â””â”€ NewSegment(path, nextID)
     â”‚
     â””â”€ ç»§ç»­æ¥æ”¶å†™å…¥

  å…³é”®ç®€åŒ–ï¼š
   - âœ… ä¸éœ€è¦å†™å…¥ Footer
   - âœ… ä¸éœ€è¦å†™å…¥ Index Block
   - âœ… ä¸éœ€è¦è®¡ç®— CRC32
   - âœ… å…³é—­æ–‡ä»¶å³å¯ï¼Œè½®è½¬å®Œæˆ

  ---

### ğŸ“Š å¯¹æ¯”ï¼šåŸæ¶æ„ vs Hint File æ¶æ„


  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ ç»´åº¦      â”‚ åŸæ¶æ„ï¼ˆFooter + Index Blockï¼‰        â”‚ Hint File æ¶æ„                â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ **å†™å…¥å¤... â”‚ éœ€è¦ç»´æŠ¤å†…å­˜ç´¢å¼• + å†™å…¥æ—¶è¿½åŠ  Meta    â”‚ çº¯è¿½åŠ ï¼Œä¸éœ€è¦ç»´æŠ¤å†…éƒ¨ç´¢å¼•    â”‚
  â”‚ **è½®è½¬å¤... â”‚ éœ€è¦å†™å…¥ Footerï¼ˆMagic + CRC + Ind... â”‚ ç®€å•å…³é—­æ—§æ–‡ä»¶ï¼Œåˆ›å»ºæ–°æ–‡ä»¶    â”‚
  â”‚ å´©æºƒæ¢å¤  â”‚ éœ€è¦éªŒè¯ Footerï¼Œè§£æ Index Block     â”‚ çº¿æ€§æ‰«ææ‰¾åˆ°æœ€åä¸€ä¸ªå®Œæ•´ B... â”‚
  â”‚ å¯åŠ¨åŠ è½½  â”‚ éœ€è¦åŠ è½½æ‰€æœ‰ Segment çš„ Index Block   â”‚ å¯é€‰æ‹©åŠ è½½ Hint æˆ–æ‰«æé‡å»º    â”‚
  â”‚ å†…å­˜å ç”¨  â”‚ Active + Older éƒ½éœ€è¦ç»´æŠ¤å†…å­˜ç´¢å¼•     â”‚ åªéœ€ç»´æŠ¤ Active çš„ Hint       â”‚
  â”‚ **ä»£ç å¤... â”‚ é«˜ï¼ˆéœ€è¦å¤„ç† Footer ç¼–ç ï¼‰            â”‚ ä½ï¼ˆçº¿æ€§æ‰«æå³å¯ï¼‰            â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---

## ğŸ”§ å¼€å‘æŒ‡å—

### å®‰è£…ä¾èµ–
```bash
# åŸºç¡€æ¡†æ¶
go get github.com/spf13/cobra
go get github.com/spf13/viper
go get github.com/gin-gonic/gin
go get github.com/uber-go/zap

# ä¸šåŠ¡ä¾èµ–
go get github.com/gopcua/opcua
go get github.com/golang/snappy
```

### ç¼–è¯‘é¡¹ç›®
```bash
# ç¼–è¯‘æœåŠ¡ç«¯
go build -o bin/server ./cmd/server

# ç¼–è¯‘ CLI
go build -o bin/cli ./cmd/cli

# ç¼–è¯‘æ‰€æœ‰
go build ./...
```

### è¿è¡ŒæœåŠ¡
```bash
# ä½¿ç”¨é»˜è®¤é…ç½®
./bin/server

# æŒ‡å®šé…ç½®æ–‡ä»¶
./bin/server -c configs/config.yaml
```

### æµ‹è¯•
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
go test ./...

# è¿è¡Œç‰¹å®šåŒ…æµ‹è¯•
go test ./internal/engine

# è¿è¡ŒåŸºå‡†æµ‹è¯•
go test -bench=. ./test/benchmark

# æŸ¥çœ‹è¦†ç›–ç‡
go test -cover ./...
```

### ä»£ç è§„èŒƒ
- éµå¾ª Go æ ‡å‡†å·¥ç¨‹å¸ƒå±€
- ä½¿ç”¨ `gofmt` æ ¼å¼åŒ–ä»£ç 
- é€šç”¨å·¥å…·æ”¾ `pkg/`ï¼Œæ ¸å¿ƒä¸šåŠ¡æ”¾ `internal/`
- æ‰€æœ‰å…¬å¼€ API éœ€è¦æ³¨é‡Š
- é”™è¯¯å¤„ç†è¦æ˜ç¡®ï¼Œé¿å… `panic`

---

## âš™ï¸ é…ç½®è¯´æ˜

### é…ç½®æ–‡ä»¶ä½ç½®
`configs/config.yaml`

### å…³é”®é…ç½®é¡¹

#### OPC UA é…ç½®
```yaml
opc:
  endpoint: "opc.tcp://localhost:53530"
  node_ids:
    - "ns=3;i=1001"
  subscription_interval: "1s"
```

#### å­˜å‚¨é…ç½®
```yaml
storage:
  dir_path: "/tmp/bitcask-iot"
  data_file_size: 512MB
  sync_write: false
  rotation_interval: "1h"
```

#### æ—¥å¿—é…ç½®
```yaml
logger:
  level: "info"
  output: "./logs/bitcask-iot.log"
  max_size: 100
  max_backups: 3
  max_age: 7
```

#### HTTP æœåŠ¡é…ç½®
```yaml
server:
  host: "0.0.0.0"
  port: 8080
```

---

## ğŸ—ºï¸ æç®€è·¯çº¿å›¾

Phase 1: Storage (å­˜) Blockå®šä¹‰ -> Gobåºåˆ—åŒ– -> Segmentæ–‡ä»¶ -> Appendè¿½åŠ 

Phase 2: Index (ç®¡) Serieså¯¹è±¡ -> ActiveBufferç¼“å†² -> Flushåˆ·ç›˜ -> GetOrCreateå¹¶å‘

Phase 3: Engine (æ§) Putå†™å…¥ -> å†…å­˜é˜ˆå€¼æ£€æŸ¥ -> QueryæŸ¥è¯¢ -> äºŒåˆ†æŸ¥æ‰¾

Phase 4: Service (ç”¨) Mainå…¥å£ -> Gin HTTP -> APIæµ‹è¯•


## ğŸ“Š å½“å‰çŠ¶æ€

### âœ… å·²å®Œæˆ
- é¡¹ç›®ç›®å½•ç»“æ„æ­å»º
- åŸºç¡€é…ç½®æ–‡ä»¶å®šä¹‰
- æ¶æ„è®¾è®¡æ–‡æ¡£ï¼ˆ01_architecture_structure.mdï¼‰
- æ ¸å¿ƒåŠŸèƒ½è®¾è®¡æ–‡æ¡£ï¼ˆ02_core_features.mdï¼‰
- æŠ€æœ¯æ ˆé€‰å‹æ–‡æ¡£ï¼ˆ03_tech_stack.mdï¼‰

### ğŸš§ å¾…å®ç°
- [ ] internal/collector - OPC UA å®¢æˆ·ç«¯å®ç°
- [ ] internal/engine - æ ¸å¿ƒå¼•æ“åè°ƒå™¨
- [ ] internal/index - ç¨€ç–ç´¢å¼•å®ç°
- [ ] internal/storage - Segment æ–‡ä»¶ç®¡ç†
- [ ] internal/query - æŸ¥è¯¢è¿­ä»£å™¨å’Œé™é‡‡æ ·
- [ ] internal/service - HTTP API å®ç°
- [ ] pkg/config - é…ç½®åŠ è½½é€»è¾‘
- [ ] pkg/logger - æ—¥å¿—å°è£…

### ğŸ¯ ä¼˜å…ˆçº§
1. **é«˜ä¼˜å…ˆçº§**: storage å’Œ engineï¼ˆæ ¸å¿ƒå­˜å‚¨å¼•æ“ï¼‰
2. **ä¸­ä¼˜å…ˆçº§**: collector å’Œ queryï¼ˆæ•°æ®é‡‡é›†å’ŒæŸ¥è¯¢ï¼‰
3. **ä½ä¼˜å…ˆçº§**: service å’Œå·¥å…·ï¼ˆAPI å’Œ CLIï¼‰

---

## ğŸ“ å¼€å‘æ³¨æ„äº‹é¡¹

### æ€§èƒ½ä¼˜åŒ–
- ä½¿ç”¨ `sync.Pool` å‡å°‘å†…å­˜åˆ†é…
- æ‰¹é‡å†™å…¥å‡å°‘ç£ç›˜ I/O
- ç´¢å¼•åœ¨å†…å­˜ä¸­ä¿æŒç´§å‡‘
- å‹ç¼©ç®—æ³•é€‰æ‹©åœ¨ CPU å’Œç£ç›˜ I/O é—´å¹³è¡¡

### å®‰å…¨è€ƒè™‘
- WAL å¿…é¡»åœ¨æ•°æ®å†™å…¥ Buffer å‰è½ç›˜
- Segment æ–‡ä»¶é‡‡ç”¨ Append-Only æ¨¡å¼
- å´©æºƒæ¢å¤æ—¶éªŒè¯æ•°æ®å®Œæ•´æ€§
- é…ç½®æ–‡ä»¶æƒé™æ§åˆ¶

### æµ‹è¯•ç­–ç•¥
- å•å…ƒæµ‹è¯•è¦†ç›–æ ¸å¿ƒé€»è¾‘
- åŸºå‡†æµ‹è¯•éªŒè¯æ€§èƒ½æŒ‡æ ‡
- é›†æˆæµ‹è¯•éªŒè¯å®Œæ•´æµç¨‹
- æ··æ²Œæµ‹è¯•éªŒè¯å´©æºƒæ¢å¤

---

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork æœ¬é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

### æäº¤è§„èŒƒ
- feat: æ–°åŠŸèƒ½
- fix: ä¿®å¤ bug
- docs: æ–‡æ¡£æ›´æ–°
- style: ä»£ç æ ¼å¼è°ƒæ•´
- refactor: é‡æ„
- test: æµ‹è¯•ç›¸å…³
- chore: æ„å»º/å·¥å…·é“¾ç›¸å…³

